# Develop
docker-develop: &DOCKER
  stage: build
  variables:
    ISTIO_VIRTUAL_SERVICE: ${DOMAIN_DEVELOP}
    ECR: ${ECR_DEVELOP}
    REPLICAS: ${REPLICAS_DEVELOP}
    OIDC_ISSUER: ${OIDC_ISSUER_DEVELOP}
    OIDC_JWKS_URI: ${OIDC_JWKS_URI_DEVELOP}
  image: 011855232551.dkr.ecr.us-east-1.amazonaws.com/phi/infrastructure/node:latest
  before_script:
    - cp -r /root/deployment .
  script:
    - cat package.json | grep version |cut -d ":" -f2|sed "s/\"//g"|sed "s/ //g"|cut -d "," -f1 > ./deployment/APP_VERSION
    - npm install
    - node ./scripts/shell/build-cronjob.js
    - node ./scripts/shell/build-deployment.js
    - cp ./Dockerfile ./deployment
  cache:
    key: deployment
    policy: push
    paths:
      - ./deployment
  artifacts:
    name: '$CI_JOB_NAME'
    expire_in: 15min
    paths:
      - ./deployment
  only:
    - develop

typescript-develop: &TYPESCRIPT
  stage: build
  image: somosphi/node:latest
  script:
    - npm install
    - npm run build
  artifacts:
    name: '$CI_JOB_NAME'
    expire_in: 15min
    paths:
      - ./release
  only:
    - develop

pushing-develop: &PUSHING
  stage: publish
  image: 011855232551.dkr.ecr.us-east-1.amazonaws.com/fintech/phi/runner/docker-4all-hlg:v1
  variables:
    ECR: ${ECR_DEVELOP}
  before_script:
    - chmod u+x ./deployment/script-push-image.sh
  script:
    - export APP_VERSION=$(cat ./deployment/APP_VERSION)
    - ./deployment/script-push-image.sh
  dependencies:
    - docker-develop
    - typescript-develop
  only:
    - develop

kubernetes-develop: &KUBERNETES
  stage: deploy
  image: 011855232551.dkr.ecr.us-east-1.amazonaws.com/fintech/phi/runner/ubuntu-deploy:v1
  variables:
    CLUSTER_NAME: ${CLUSTER_DEVELOP}
  before_script:
    - chmod u+x ./deployment/script-git-push.sh
  script:
    - ./deployment/script-git-push.sh
  dependencies:
    - docker-develop
  only:
    - develop

# Master
docker-master:
  <<: *DOCKER
  variables:
    ISTIO_VIRTUAL_SERVICE: ${DOMAIN_MASTER}
    ECR: ${ECR_PRODUCTION}
    REPLICAS: ${REPLICAS_PRODUCTION}
    OIDC_ISSUER: ${OIDC_ISSUER_PROD}
    OIDC_JWKS_URI: ${OIDC_JWKS_URI_PROD}
  only:
    - master

typescript-master:
  <<: *TYPESCRIPT
  only:
    - master

pushing-master:
  <<: *PUSHING
  image: 011855232551.dkr.ecr.us-east-1.amazonaws.com/fintech/phi/runner/docker-4all-prd:v1
  variables:
    ECR: ${ECR_PRODUCTION}
  dependencies:
    - docker-master
    - typescript-master
  only:
    - master

kubernetes-master:
  <<: *KUBERNETES
  variables:
    CLUSTER_NAME: ${CLUSTER_PRODUCTION}
  dependencies:
    - docker-master
  only:
    - master
